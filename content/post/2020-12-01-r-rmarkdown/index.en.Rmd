---
title: "Making Maps about Trees"
author: "Ingrid Zoll"
date: 2020-08-22T21:13:14-05:00
categories: ["R"]
tags: ["R Markdown", "mapping", "trees"]
output:
  html_document:
    df_print: paged
---

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(leaflet)
library(pdxTrees)
library(forcats)
library(widgetframe)
```

# Western Redcedar trees in Portland Oregon
### Data from the Portland Parks Tree Inventory

```{r data wrangling}
#order: lon, lat, species, date, condition, common name, scientific name, family, collected by

parks<-get_pdxTrees_parks() #full data


smallparks <- parks %>%
  select(1, 2, 8, 7, 10, 9, 17, 5, 15, 6) %>% #select columns, reorder
  mutate(source="park")

streets<-get_pdxTrees_streets() #full data

smallstreets<- streets %>%
  select(22, 23, 3, 2, 5, 18, 15, 16, 14, 4) %>% #select columns, reorder 
  rename("Scientific_Name"="Scientific") %>%
  mutate(source="street")


pdxTrees <- bind_rows(smallparks, smallstreets) #join
```

```{r THPL wrangling}
thpl <- pdxTrees %>%
  filter(Species=="THPL") %>%
  filter(!is.na(Collected_By))

thpl$Condition <- factor(thpl$Condition) %>%
  fct_relevel(c("Good", "Fair", "Poor"))

thplgood <- thpl %>%
  filter(Condition =="Good")

thplfair <- thpl %>%
  filter(Condition =="Fair")

thplpoor <- thpl %>%
  filter(Condition =="Poor")
```

## Map 1

If you click on an individual dot which represents a single Western Redcedar tree in Portland, OR, you can see whether the data was collected by a staff member or a volunteer, the date it was collected, and the DBH (diameter at base height).


```{r, message=FALSE, warning=FALSE}
#create color palette for condition
pal <- colorFactor(c("goldenrod1", "forestgreen", "tomato"), 
                   domain = c("Good", "Fair", "Poor"))

#creating map 1
map1 <- leaflet(data = thpl, options = leafletOptions(minZoom = 10, maxZoom = 21)) %>% 
  setView(lng = -122.6, lat = 45.5, zoom = 11) %>%
  addProviderTiles(providers$Stamen.Toner) %>%
  addCircleMarkers(lng = ~Longitude, lat = ~Latitude, 
             popup=paste("Collected by:", thpl$Collected_By, "<br>",
                           "Date:", thpl$Inventory_Date, "<br>",
                           "DBH:", thpl$DBH), 
             color=~pal(Condition), 
             clusterOptions = markerClusterOptions(disableClusteringAtZoom=14), 
             stroke = TRUE, fillOpacity = 0.7, radius = 3) %>%
  addLegend("bottomright", pal = pal, 
            values= ~Condition,
            title = "Condition",
            opacity = 1)

frameWidget(map1, width = "100%")
```

```{r, eval=FALSE, include=FALSE}
popup=paste("Collected by:", trees$Collected_By, "<br>",
                           "Date:", trees$Date, "<br>",
                           "DBH:", trees$DBH)
```

## Map 2

If you click on an individual dot which represents a single Western Redcedar tree in Portland, OR, you can see whether the data was collected by a staff member or a volunteer, the date it was collected, and the DBH (diameter at base height).

You can also sort the map by condition by checking/unchecking the boxes in the upper righthand corner

```{r, message=FALSE, warning=FALSE}
#creating map 2
map2 <- leaflet(options = leafletOptions(minZoom = 11, maxZoom = 21)) %>%
  addTiles() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(lng = ~Longitude, lat = ~Latitude,
      popup=paste("Collected by:", thplgood$Collected_By, "<br>",
                           "Date:", thplgood$Inventory_Date, "<br>",
                           "DBH:", thplgood$DBH),
      data = thplgood, radius = 4,
      color = "forestgreen", stroke=FALSE,
      fillOpacity = 0.6, 
      group = "Good") %>%
  addCircleMarkers(lng = ~Longitude, lat = ~Latitude, 
      popup=paste("Collected by:", thplfair$Collected_By, "<br>",
                           "Date:", thplfair$Inventory_Date, "<br>",
                           "DBH:", thplfair$DBH),
      data = thplfair, radius = 4,
      color = "gold", stroke=FALSE,
      fillOpacity = 0.6,
      group = "Fair") %>%
   addCircleMarkers(lng = ~Longitude, lat = ~Latitude, 
      popup=paste("Collected by:", thplpoor$Collected_By, "<br>",
                           "Date:", thplpoor$Inventory_Date, "<br>",
                           "DBH:", thplpoor$DBH),
      data = thplpoor, radius = 4,
      color = "tomato", stroke=FALSE,
      fillOpacity = 0.6,
      group = "Poor") %>%
 addLayersControl(
      overlayGroups = c("Good", "Fair", "Poor"),
      options = layersControlOptions(collapsed = FALSE))

frameWidget(map2, width = "100%")
```


```{r, eval=FALSE, include=FALSE}
thpl %>%
  count(Condition, Collected_By)

thpl %>%
  count(Collected_By)
```

```{r, eval=FALSE, include=FALSE}
# 2-Way Frequency Table
attach(thpl)
mytable <- table(Condition,source) # A will be rows, B will be columns
mytable # print table

margin.table(mytable, 1) # A frequencies (summed over B)
margin.table(mytable, 2) # B frequencies (summed over A)

prop.table(mytable) # cell percentages
prop.table(mytable, 1) # row percentages
prop.table(mytable, 2) # column percentages

chisq.test(mytable)
```

